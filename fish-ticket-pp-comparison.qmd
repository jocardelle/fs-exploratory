---
title: "Fish Ticket - Processed Products Comparison EDA"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

# Setup

```{r}
# Load libraries
library(tidyverse)
library(here)
library(janitor)
library(dplyr)
library(stringr)
library(snakecase)
library(ggbump)
library(purrr)
library(scales)
library(paletteer)
```

```{r}
# Read in data
ft_dealer_23 <- read_csv(here("data/pacfin/ftid_dealer_09_23.csv")) %>% 
  filter(PACFIN_YEAR ==2023) %>% 
  clean_names()


dealers <- ft_dealer_23 %>% 
  mutate(total_weight = sum(landed_weight_lbs))

dealers <- dealers %>% 
  mutate(
    company = str_split_fixed(dealer_name, "  ", 2)[, 1],
    location = str_split_fixed(dealer_name, "  ", 2)[, 2]
  ) %>% 
  mutate(dealer = str_split_fixed(company, " - ", 2)[, 1],
    location_2 = str_split_fixed(company, " - ", 2)[, 2])
  # relocate(dealer, location, location_2, .before = dealer_name) %>% 
  # select(-c(dealer_name, company)) %>% 
  # select(dealer, dealer_num) %>% 
  # distinct()

top_dealers <- dealers %>% 
  group_by(dealer) %>% 
  summarise(percent_weight = sum(landed_weight_lbs)/ total_weight * 100) %>% unique() %>% filter(percent_weight > 1)

sum(top_dealers$percent_weight)
    
n_distinct(ft_dealer_23$DEALER_NAME)

pacfin_dealers <- read_csv(here("data/pacfin/unique_dealers.csv")) %>% 
  clean_names()

processors <- read_csv(here("data/processed_products/cleaned/wc_pp_address.csv"))

fish_ports <- read_csv(here("data/pacfin/port_species.csv")) %>% 
  clean_names()

port_dealer <- read_csv(here("data/pacfin/port_species_dealer.csv")) %>% 
  clean_names()


pp_products <- read_csv(here("data/processed_products/cleaned/wc_products_location.csv"))
```

# Compare

```{r}
# Rename port `Morro` to `Morro Bay` in pacfin data
port_dealer$iopac_port_group[port_dealer$iopac_port_group=="MORRO"] <- "MORRO BAY"
fish_ports$iopac_port_group[fish_ports$iopac_port_group=="MORRO"] <- "MORRO BAY"

port_dealer$iopac_port_group <- to_snake_case(port_dealer$iopac_port_group)

# Should dealer_num or dealer_id be used??
n_distinct(pacfin_dealers$dealer_num)
n_distinct(pacfin_dealers$dealer_id)
n_distinct(processors$pp_idnum)

# Check for matches in either dealer_num or dealer_id to pp_idnum
pp_unique <- processors %>% 
  select(pp_idnum) %>% 
  unique()

ft_dealernum <- pacfin_dealers %>% 
  select(dealer_num) %>% 
  unique() %>% 
  rename(pp_idnum = dealer_num) 

ft_dealernum$pp_idnum <- as.numeric(ft_dealernum$pp_idnum)

ft_dealerid <- pacfin_dealers %>% 
  select(dealer_id) %>% 
  unique() %>% 
  rename(pp_idnum = dealer_id)

ft_dealerid$pp_idnum <- as.numeric(ft_dealerid$pp_idnum)

pp_dealernum <- inner_join(pp_unique, ft_dealernum, by = "pp_idnum")
pp_dealerid <- inner_join(pp_unique, ft_dealerid, by = "pp_idnum")

sb_abalone_pp <- processors %>% 
  filter(company == "SANTA BARBARA ABALONE")

sb_abalone_pacfin <- pacfin_dealers %>%
      filter(str_detect(dealer_name, "SANTA BARBARA ABALONE"))
```

```{r}
# Add same generalized column to fish ticket as pp
general_products <- c(
  "SALMON" = "SALMON",
  "TUNA" = "TUNA",
  "ALBACORE" = "TUNA",
  "HAKE" = "HAKE",
  "WHITING" = "HAKE",
  "WAHOO" = "WAHOO",
  "CRAB" = "CRAB",
  "HALIBUT" = "HALIBUT",
  "SABLEFISH" = "SABLEFISH",
  "SQUID" = "SQUID",
  "SHRIMP" = "SHRIMP",
  "BONITO" = "TUNA",
  "COD" = "COD",
  "CUCUMBER" = "SEA CUCUMBER",
  "FLOUNDER" = "FLOUNDER",
  "POLLOCK" = "POLLOCK",
  "THORNYHEAD" = "ROCKFISH",
  "RCKFSH" = "ROCKFISH",
  "PERCH" = "ROCKFISH",
  "ROCKFISH" = "ROCKFISH",
  "TROUT" = "TROUT",
  "CLAM" = "CLAMS",
  "OYSTER" = "OYSTERS",
  "SWORD" = "SWORDFISH",
  "DRUM" = "DRUM",
  "TILAPIA" = "TILAPIA",
  "BASS" = "BASS",
  "GROUPER" = "GROUPER",
  "MARLIN" = "MARLIN",
  "ESCOLAR" = "ESCOLAR",
  "OCTOPUS" = "OCTOPUS",
  "BUFFALO" = "BUFFALOFISH",
  "STURGEON" = "STURGEON",
  "MUSSEL" = "MUSSELS",
  "SKATE" = "SKATES",
  "LOBSTER" = "LOBSTER",
  "DOLPHIN" = "DORADO",
  "OPAH" = "OPAH",
  "ANGLER" = "ANGLER",
  "ROUGHY" = "ORANGE ROUGHY",
  "CRAW" = "CRAWFISH",
  "SMELT" = "SMELT",
  "JACK" = "JACK",
  "SARDINE" = "SARDINE",
  "SEAWEED" = "SEAWEED",
  "HERRING" = "HERRING",
  "MACKEREL" = "MACKEREL",
  "SCALLOP" = "SCALLOPS",
  "SOLE" = "SOLE",
  "SHARK" = "SHARK",
  "BARRACUDA" = "SHARK",
  "ABALONE" = "ABALONE",
  "BOCACCIO" = "BOCACCIO"
)

# Loop through the generalized terms
port_dealer <- port_dealer %>%
  mutate(product_general = sapply(pacfin_species_common_name, function(x) {
    match <- names(general_products)[str_detect(x, names(general_products))]
    if (length(match) > 0) {
      general_products[match[1]]
    } else if (str_detect(x, "MISC")) { #UNCL to unclassified if didn't match others
      "UNCLASSIFIED"
    } else {
      "OTHER" # Assigned other if nothing else
    }
  }))

other_products <- port_dealer %>% 
  filter(product_general == "OTHER")

write.csv(port_dealer, file = here("data/pacfin/pacfin_products_general.csv"), row.names = FALSE)
port_dealer <- read_csv(here("data/pacfin/pacfin_products_general.csv"))
```

# Poundage Comparison

```{r}
port_dealer$iopac_port_group <- to_snake_case(port_dealer$iopac_port_group)

# Add a new column for regions
ft_port_products <- port_dealer %>% 
  mutate(
    region = case_when(
      iopac_port_group %in% c("north_wa_coast", "puget_sound", "south_and_central_wa_coast") ~ "WA",
      iopac_port_group %in% c( "astoria", "columbia_river", "tillamook", "newport", "coos_bay", "brookings") ~ "OR",
      iopac_port_group %in% c("crescent_city", "eureka", "fort_bragg", "bodega_bay") ~ "Northern CA",
      iopac_port_group %in% c("san_francisco", "monterey", "morro_bay") ~ "Central CA",
      iopac_port_group %in% c("santa_barbara", "los_angeles", "san_diego") ~ "Southern CA"
    )
  )

# Filter to the same years as fish ticket data
pp_products <- pp_products %>% 
  filter(1981 <= year)
pp_products <- pp_products %>% 
  rename(iopac_port_group = io_pac_port_group)


# Select columns of interest and group by region and product
ft_region_products <- ft_port_products %>% 
  group_by(region, product_general) %>% 
  summarise(ft_poundage = sum(landed_weight_lbs)) %>% 
  mutate(dataset = "Fish Tickets")

pp_region_products <- pp_products %>% 
  group_by(region, product_general) %>% 
  summarise(pp_poundage = sum(pounds)) %>% 
  mutate(dataset = "Processed Products")

region_products <- full_join(ft_region_products, pp_region_products, by = c("region", "product_general"))

region_products <- region_products %>%
  select(region, product_general, ft_poundage, pp_poundage) %>%
  pivot_longer(cols = c(ft_poundage, pp_poundage),
               names_to = "dataset",
               values_to = "poundage") %>%
  mutate(dataset = case_when(
    dataset == "ft_poundage" ~ "Fish Tickets",
    dataset == "pp_poundage" ~ "Processed Products"
  ))
```

# Bump charts function

```{r}
# Create function to compare fish ticket and processed products species poundage in a region (top 90% or top 10 products)
region_product_bump_chart <- function(region_name, filter_type = c("top10", "top90")) {
  
  filter_type <- match.arg(filter_type)
  
  # Filter to a region
  region_data <- region_products %>%
    filter(region == region_name)
  
  # Apply filter
  if (filter_type == "top10") {
    region_filtered <- region_data %>%
      group_by(product_general) %>%
      summarise(total_poundage = sum(poundage, na.rm = TRUE)) %>%
      slice_max(order_by = total_poundage, n = 10) %>%
      inner_join(region_data, by = "product_general")
    
    plot_title <- paste(region_name, " Top 10 Products by Poundage (1981-2023)", sep = "")
    
  } else if (filter_type == "top90") {
    region_filtered <- region_data %>%
      group_by(product_general) %>%
      summarise(total_poundage = sum(poundage, na.rm = TRUE)) %>%
      arrange(desc(total_poundage)) %>%
      mutate(cumshare = cumsum(total_poundage) / sum(total_poundage)) %>%
      filter(cumshare <= 0.9) %>%
      inner_join(region_data, by = "product_general")
    
    plot_title <- paste(region_name, " Products Contributing to Top 90% of Poundage (1981-2023)", sep = "")
  }
  
  # Rank within fish ticket or processed products
  region_ranked <- region_filtered %>%
    group_by(dataset) %>%
    mutate(rank = rank(-poundage, ties.method = "first")) %>%
    ungroup()
  
  # Plot bump chart
  ggplot(region_ranked, aes(x = dataset, y = rank, group = product_general, color = product_general)) +
    geom_bump(size = 1.2, smooth = 8) +
    geom_point(size = 4) +
    scale_color_paletteer_d("ggthemes::Color_Blind") +
    geom_text(aes(label = paste0(
  product_general, " (", 
  scales::label_number(
    accuracy = 0.1, 
    scale_cut = scales::cut_short_scale()
  )(poundage), 
  ")"
)),
hjust = ifelse(region_ranked$dataset == "Fish Tickets", 1.1, -0.1),
size = 4) +
    scale_y_reverse(breaks = 1:max(region_ranked$rank)) +
    theme_minimal(base_size = 14) +
    theme(legend.position = "none",
          panel.grid.minor = element_blank()) +
    labs(title = plot_title,
         x = "Dataset",
         y = "Rank")
}
```

# Make bump charts for each region

```{r}
region_product_bump_chart("WA", filter_type = "top90")
region_product_bump_chart("OR", filter_type = "top90")
region_product_bump_chart("Northern CA", filter_type = "top90")
region_product_bump_chart("Central CA", filter_type = "top90")
region_product_bump_chart("Southern CA", filter_type = "top90")
```

# Sardine Exploration

```{r}
# Processed Products
sardine <- pp_products %>% 
  filter(product_general == "SARDINE") %>% 
  group_by(region, year) %>% 
  summarise(poundage = sum(pounds),
            revenue = sum(dollars))

sardine$region <- factor(sardine$region, levels = region_location)

pp_sardine <- ggplot(sardine, aes(x = year, y = poundage, colour = region)) +
  geom_line(size = 1.25) +
  scale_y_continuous(labels = label_number(scale = 1e-6, suffix = " M")) +
  scale_color_viridis_d() +
  labs(title = "Yearly Processed Pounds of Sardine") +
  ylab("Pounds") +
  xlim(1980, 2022) +
  theme_minimal()

ggplot(sardine, aes(x = year, y = revenue, colour = region)) +
  geom_line(size = 1) +
  scale_y_continuous(labels = label_number(scale = 1e-6, suffix = " M")) +
  scale_color_viridis_d() +
  labs(title = "Yearly Processor Revenue from Sardine") +
  theme_minimal()

# Fish Ticket
fish_ticket <- read_csv("data/pacfin/pacfin_products_general.csv")
ft_sardine <- fish_ticket %>%
  filter(product_general == "SARDINE")

# Convert port group to snake case
ft_sardine$iopac_port_group <- to_snake_case(ft_sardine$iopac_port_group)
# Assign Region
ft_sardine <- ft_sardine %>%
  mutate(
    region = case_when(
      iopac_port_group %in% c("north_wa_coast", "puget_sound", "south_and_central_wa_coast") ~ "WA",
      iopac_port_group %in% c( "astoria", "columbia_river", "tillamook", "newport", "coos_bay", "brookings") ~ "OR",
      iopac_port_group %in% c("crescent_city", "eureka", "fort_bragg", "bodega_bay") ~ "Northern CA",
      iopac_port_group %in% c("san_francisco", "monterey", "morro_bay") ~ "Central CA",
      iopac_port_group %in% c("santa_barbara", "los_angeles", "san_diego") ~ "Southern CA"
    )
  )

ft_sardine_pounds <- ft_sardine %>% 
  group_by(region, pacfin_year) %>% 
  summarise(poundage = sum(landed_weight_lbs),
            revenue = sum(revenue))

ft_sardine_pounds$region <- factor(ft_sardine_pounds$region, levels = region_location)

ft_sardine <- ggplot(ft_sardine_pounds, aes(x = pacfin_year, y = poundage, colour = region)) +
  geom_line(size = 1.25) +
  scale_y_continuous(labels = label_number(scale = 1e-6, suffix = " M")) +
  scale_color_viridis_d() +
  labs(title = "Yearly Fish Ticket Pounds from Sardine") +
  xlim(1980, 2022) +
  ylab("Pounds") +
  xlab("Year") +
  theme_minimal()
  
ft_sardine
```
